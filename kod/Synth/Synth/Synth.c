/*
* Synth.c
*
* Created: 3/24/2013 4:23:53 AM
*  Author: erikhk
*/

#define F_CPU 20000UL

#include <avr/io.h>
#include <util/delay.h>
#include <avr/power.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include "l74hc165.h"
#include "lcd.h"


#define F_INT F_CPU/512
//F_INT = 39063 Hz
#define FS F_INT/2
//FS = 19531 Hz

#define MAX_LEVEL 128

#define OSCILLATORS 6
uint16_t freq_coefficient[OSCILLATORS];
uint16_t detune[OSCILLATORS];

uint8_t square_[] = {254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

uint8_t sine[] = {128,131,134,137,140,144,147,150,153,156,159,162,165,168,171,174,177,180,182,185,188,191,194,196,199,201,204,206,209,211,214,216,218,220,222,224,226,228,230,232,234,236,237,239,240,242,243,244,246,247,248,249,250,251,251,252,253,253,254,254,254,255,255,255,255,255,255,255,254,254,253,253,252,252,251,250,249,248,247,246,245,244,242,241,240,238,236,235,233,231,229,227,225,223,221,219,217,215,212,210,208,205,203,200,197,195,192,189,187,184,181,178,175,172,169,167,164,160,157,154,151,148,145,142,139,136,133,130,126,123,120,117,114,111,108,105,102,99,96,92,89,87,84,81,78,75,72,69,67,64,61,59,56,53,51,48,46,44,41,39,37,35,33,31,29,27,25,23,21,20,18,16,15,14,12,11,10,9,8,7,6,5,4,4,3,3,2,2,1,1,1,1,1,1,1,2,2,2,3,3,4,5,5,6,7,8,9,10,12,13,14,16,17,19,20,22,24,26,28,30,32,34,36,38,40,42,45,47,50,52,55,57,60,62,65,68,71,74,76,79,82,85,88,91,94,97,100,103,106,109,112,116,119,122,125,128};
uint8_t sawtooth[] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255};
uint8_t triangle[] = {0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,254,252,250,248,246,244,242,240,238,236,234,232,230,228,226,224,222,220,218,216,214,212,210,208,206,204,202,200,198,196,194,192,190,188,186,184,182,180,178,176,174,172,170,168,166,164,162,160,158,156,154,152,150,148,146,144,142,140,138,136,134,132,130,128,126,124,122,120,118,116,114,112,110,108,106,104,102,100,98,96,94,92,90,88,86,84,82,80,78,76,74,72,70,68,66,64,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0};
uint8_t pseudosquare[] = {224,224,225,225,226,227,229,230,231,233,234,235,236,237,238,238,238,237,236,235,234,232,230,228,226,224,222,220,218,216,215,214,214,214,215,216,217,219,221,224,226,229,232,235,237,239,241,242,242,242,240,238,235,230,225,219,211,203,193,183,172,161,149,137,125,113,101,89,78,68,58,49,41,34,28,23,19,17,15,14,14,15,16,18,20,23,26,28,31,34,36,38,40,41,42,42,42,41,40,39,37,35,33,31,29,27,25,23,21,20,19,18,18,18,18,19,20,21,22,24,25,27,28,29,30,31,32,32,32,32,31,30,29,28,27,25,24,22,21,20,19,18,18,18,18,19,20,21,23,25,27,29,31,33,35,37,39,40,41,42,42,42,41,40,38,36,34,31,28,26,23,20,18,16,15,14,14,15,17,19,23,28,34,41,49,58,68,78,89,101,113,125,137,149,161,172,183,193,203,211,219,225,230,235,238,240,242,242,242,241,239,237,235,232,229,226,224,221,219,217,216,215,214,214,214,215,216,218,220,222,224,226,228,230,232,234,235,236,237,238,238,238,237,236,235,234,233,231,230,229,227,226,225,225,224,224};

//const uint8_t PROGMEM triangle[] = {1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,31,29,27,25,23,21,19,17,15,13,11,9,7,5,3,1};
//const uint8_t PROGMEM bent[] = {1,3,4,6,7,9,10,12,13,15,16,18,19,21,22,24,25,27,28,30,31,33,34,36,37,39,40,42,43,45,46,48,49,51,52,54,55,57,58,60,61,63,64,66,67,69,70,72,73,75,76,78,79,81,82,84,85,87,88,90,91,93,94,96,97,99,100,102,103,105,106,108,109,111,112,114,115,117,118,120,121,123,124,126,127,128,130,131,133,134,136,137,139,140,142,143,145,146,148,149,151,152,154,155,157,158,160,161,163,164,166,167,169,170,172,173,175,176,178,179,181,182,184,185,187,188,190,191,193,194,196,197,199,200,202,203,205,206,208,209,211,212,214,215,217,218,220,221,223,224,226,227,229,230,232,233,235,236,238,239,241,242,244,245,247,248,250,251,253,254,124,123,121,120,118,117,115,114,112,111,109,108,106,105,103,102,100,99,97,96,94,93,91,90,88,87,85,84,82,81,79,78,76,75,73,72,70,69,67,66,64,63,61,60,58,57,55,54,52,51,49,48,46,45,43,42,40,39,37,36,34,33,31,30,28,27,25,24,22,21,19,18,16,15,13,12,10,9,7,6,4,3,1,0,0,0};
//const uint8_t PROGMEM noise[] = {37,46,46,55,45,48,45,31,58,51,43,54,59,54,49,52,55,50,53,60,40,54,32,45,49,48,62,54,41,50,46,39,43,35,60,48,38,41,47,60,31,34,44,42,33,34,47,49,54,46,37,54,62,41,63,44,53,57,62,57,40,34,49,63,52,42,47,38,45,50,60,44,42,41,59,47,48,34,60,62,52,41,45,53,54,50,39,48,49,32,45,51,34,41,37,55,36,52,47,47,55,51,33,36,55,36,36,45,44,38,34,62,39,35,47,32,51,37,61,32,36,46,48,40,36,35,41,62,45,57,50,39,37,49,35,38,39,41,41,38,49,36,51,45,41,61,55,33,55,62,52,38,47,59,57,42,61,33,51,62,59,38,52,41,54,48,54,44,38,48,58,62,36,52,41,42,44,37,56,44,33,53,45,51,56,33,57,59,44,47,51,34,35,50,62,44,49,49,45,41,37,45,52,59,34,38,38,61,33,47,47,33,46,43,46,53,41,51,56,42,57,60,47,40,45,57,60,34,42,53,43,56,58,45,35,55,54,42,51,36,53,42,37,47,48,46,45,60,43,63,32,63,54,52,37,52,50,63,31,45,51,57,47,63,40,48,40,32,35,31,45,56,62,59,32,33,33,40,47,42,36,49,56,53,62,62,44,45,44,39,49,61,60,56,36,61,59,33,53,59,60,41,59,46,47,37,48,49,56,62,60,48,46,37,32,44,34,60,46,39,58,41,61,46,57,48,49,53,36,38,55,47,36,46,55,54,45,40,35,62,59,36,61,62,49,60,51,54,51,57,63,52,44,57,62,46,39,53,31,43,56,42,58,53,58,59,51,36,53,43,37,49,57,46,47,53,59,58,61,49,55,39,53,40,54,62,59,35,40,61,55,38,40,36,41,53,61,60,41,45,47,40,37,34,31,31,60,46,49,35,40,48,62,60,33,32,57,62,42,51,48,53,60,41,31,47,52,33,50,38,33,34,53,62,31,40,42,46,42,53,51,49,38,45,52,42,60,48,42,59,63,35,38,57,57,33,32,32,59,46,33,31,39,60,58,39,41,39,48,57,52,54,41,45,33,58,53,54,49,38,54,58,37,57,49,36,46,46,42,57,46,50,39,31,41,57,48,53,48,37,48,49,53,59,37,55,63,51,45,48,37,37,48,54,44,60,51,32,53,34,34,50,40,51,51,55,31,57,49,62,61,36,47,36,51,33,54,63,36,37,58,36,34,40,41,56,37,35,46,34,46,50,55,45,62,41,55,46,36,53,39,40,37,48,37,52,39,34,55,37,38,49,59,48,57,58,59,31,60,49,40,51,49,34,59,35,49,52,42,54,34,51,49,34,38,62,55,43,37,48,51,60,60,45,43,44,42,61,38,61,44,31,42,42,50,43,36,52,48,42,51,34,45,47,50,40,54,37,41,58,45,46,57,49,42,33,42,47,62,48,41,56,42,54,37,35,63,52,59,60,54,36,62,58,55,61,58,35,56,43,41,50,48,33,48,57,61,63,34,33,51,38,38,58,58,32,36,31,41,38,36,60,58,57,32,39,32,32,52,38,43,59,39,55,31,45,60,49,32,48,44,33,41,52,43,33,58,54,51,58,45,49,43,31,56,48,60,62,62,52,57,40,49,52,35,52,31,41,40,35,47,49,37,55,50,42,42,37,43,33,42,36,50,55,40,41,37,56,33,38,60,63,43,36,55,49,48,45,48,49,36,33,34,32,43,58,61,52,60,53,36,42,33,33,62,41,49,56,60,61,41,49,62,57,41,50,38,52,50,60,38,31,35,35,53,49,42,46,36,39,54,54,47,59,42,61,55,48,43,43,47,41,43,47,54,32,52,63,46,37,56,54,47,32,53,62,38,40,59,34,45,48,51,45,45,43,36,48,34,31,45,32,34,40,36,31,40,47,61,45,63,33,43,45,45,49,33,45,62,59,36,45,57,52,35,38,44,56,52,36,37,36,55,56,54,44,62,38,47,52,61,54,57,37,38,38,57,34,51,56,63,58,50,55,36,40,36,35,60,50,32,62,33,48,40,58,45,32,34,48,47,53,39,33,35,52,51,62,56,48,36,43,51,33,63,60,62,45,56,37,53,63,36,47,60,56,51,42,32,33,42,35,37,53,56,45,42,42,35,47,55,47,59,55,33,31,55,32,55,46,44,49,43,35,46,59,41,38,38,50,53,31,58,60,36,61,61,55,54,41,42,55,33,56,34,34,53,45,39,41,33,58,60,45,47,42,54,62,35,39,57,58,39,59,52,35,43,56,33,43,35,31,58,41,44,37,51,42,47,46,37,50,60,41,52,45,34,61,50,45,52,45,46,62,39,43,33,46,52,51,38,58,35,56,43,47,56,34,52,34,49,35,56,52,37,43,35,56,53,48,34,41,51,41,53,63,55,34,57,48,62,33,33,31,54,48,40,32,53,44,44,53,35,49,58,32,56,49,44,36,46,39,48,62,54,48,32,51,43,34,50,51,44,43,54,42,32,51,45,51,35,43,39,31,41,42,43,60,50,59,60,49,61,60,44,34,32,50,51,51,63,52,34,59,56,42,34,43,51,48,40,37,46,55,61,37,43,33,53,59,52,35,42,46,48,59,34,48,56,61,42,36,51,56,51,50,61,57,44,62,46,33,34,52,51,44,63,62,48,60,48,60,40,54,49,39,50,48,37,48,46,46,60,52,62,35,41,41,48,40,46,36,57,43,51,44,59,62,38,32,48,43,43,53,51,39,57,52,54,47,50,40,43,37,52,51,32,57,50,60,51,42,46,35,60,46,51,57,38,37,39,42,59,58,50,49,48,34,43,42,45,45,49,33,57,53,46,33,58,50,61,40,52,51,43,59,46,41,36,49,51,37,38,33,57,61,42,45,37,58,49,52,48,61,49,37,53,39,35,61,57,51,52,51,38,41,31,42,49,42,31,35,33,57,41,44,63,33,61,47,56,58,60,36,38,58,37,63,37,51,43,59,56,57,49,51,37,58,32,39,32,44,33,52,44,33,49,63,57,42,35,35,32,54,43,51,37,51,59,58,46,55,43,47,55,53,36,39,62,53,38,52,37,41,57,47,52,62,62,53,36,54,63,38,56,39,48,59,61,50,48,47,46,51,54,39,55,38,56,49,40,56,54,59,33,47,50,41,31,51,59,34,32,58,59,57,53,60,52,44,56,51,43,59,53,35,40,44,48,34,62,36,34,63,49,58,53,56,60,47,55,60,40,39,32,33,36,52,57,33,45,31,44,52,49,40,40,44,50,46,45,62,57,53,46,42,50,45,33,35,50,39,41,31,42,63,48,34,55,57,55,47,37,55,57,41,46,62,61,53,49,58,54,59,61,44,51,61,60,48,37,34,60,55,41,35,45,48,52,49,40,53,42,48,36,33,43,37,52,46,45,34,53,31,52,56,60,54,59,39,50,56,41,46,47,51,47,62,34,57,55,32,36,47,43,57,46,38,31,37,60,45,55,50,62,39,61,33,58,63,49,51,46,39,42,56,43,33,63,37,58,34,53,50,47,55,47,48,62,58,62,33,46,41,57,42,45,56,37,40,34,45,51,46,32,49,56,40,58,40,54,37,59,46,32,34,42,44,45,42,61,33,34,35,40,62,45,32,60,52,38,35,49,47,35,51,38,58,63,57,59,45,33,43,57,51,54,58,59,49,49,60,56,47,41,42,33,51,63,38,33,57,47,60,56,42,39,45,45,50,33,49,53,32,44,62,34,53,56,34,42,61,61,35,40,49,51,32,43,53,55,56,51,46,35,54,34,53,51,45,54,38,44,51,58,63,60,34,62,52,43,42,49,63,41,48,62,47,38,31,51,58,47,54,54,37,53,45,41,47,39,44,35,49,55,43,48,61,51,54,48,61,40,56,61,60,58,44,54,50,51,54,60,58,52,39,36,44,51,62,45,45,46,51,38,58,46,41,62,39,58,37,45,45,57,53,39,49,49,54,46,52,49,32,47,38,35,62,53,61,40,34,52,33,43,57,45,62,58,62,60,39,62,40,41,39,33,43,32,36,47,58,32,52,61,57,61,61,47,55,34,58,32,50,52,56,56,61,55,31,59,39,42,42,54,51,58,35,56,60,52,55,58,52,55,46,31,36,56,59,61,49,46,40,57,52,43,50,60,50,49,31,63,49,38,46,32,38,33,51,59,39,51,57,44,43,32,33,40,49,59,31,50,55,57,43,43,34,39,49,62,60,53,56,46,55,44,53,46,48,53,47,45,32,38,34,48,48,48,41,42,52,31,57,47,60,33,40,59,34,49,48,38,46,32,43,42,32,50,55,38,38,47,48,34,35,49,45,36,61,59,41,44,61,52,39,32,51,58,48,62,61,37,50,32,46,41,38,32,61,46,50,36,57,46,39,61,35,31,50,33,53,38,43,46,31,56,54,41,41,54,48,36,48,57,53,45,33,42,52,44,42,33,36,40,49,35,58,62,46,59,45,36,44,41,58,50,46,61,60,63,33,35,43,38,37,53,40,52,55,44,62,37,32,58,53,56,57,46,37,36,54,32,47,54,35,33,51,40,61,61,62,32,33,54,36,54,62,49,39,47,49,60,58,57,56,49,43,32,39,36,40,32,36,37,39,52,54,45,50,56,36,39,55,52,35,45,45,38,59,35,35,34,31,47,53,53,55,35,48,49,49,49,34,36,53,47,32,61,49,41,49,42,48,63,41,34,33,48,58,32,37,56,60,56,58,53,55,46,56,32,46,57,60,55,39,38,34,54,57,52,62,43,41,37,57,50,47,43,58,36,56,51,47,63,46,48,50,62,32,33,35,33,59,46,53,34,36,43,41,34,55,51,43,62,46,51,38,61,51,48,37,46,37,58,45,48,46,51,37,42,45,31,51,35,35,40,43,53,47,50,37,56,34,62,58,47,61,59,39,60,38,52,41,62,49,40,46,34,45,40,52,41,49,41,60,32,59,57,42,62,50,59,61,41,49,41,60,32,35,42,61,46,60,41,44,42,56,60,48,50,44,62,54,35,42,46,50,53,32,50,42,46,48,62,53,31,43,39,54,33,36,53,31,39,63,38,44,43,36,50,52,62,50,42,33,47,51,44,45,44,52,60,54,57,40,41,46,35,51,36,52,60,52,41,53,59,47,34,59,36,54,44,35,47,47,53,46,49,46,35,34,53,36,58,43,38,52,35,55,43,52,35,63,56,46,49,51,34,55,54,43,42,39,33,60,39,31,44,52,53,54,60,44,55,44,37,36,49,46,34,39,36,50,62,54,50,54,50,54,50,53,33,40,51,62,58,45,37,32,42,38,61,35,35,43,42,63,58,47,54,40,60,42,54,35,49,56,34,35,51,33,33,34,33,31,62,48,40,38,58,33,39,47,53,40,61,52,61,45,46,57,35,62,32,48,46,59,43,51,32,37,61,31,59,62,37,49,53,51,59,62,57,33,62,41,52,32,35,43,56,42,40,45,48,47,54,43,49,36,39,56,60,33,55,59,62,39,58,62,44,42,39,44,53,56,34,44,36,56,53,48,32,32,40,45,54,59,38,32,50,44,47,58,45,46,48,37,37,43,55,46,62,58,51,44,34,51,51,59,57,56,52,44,59,37,36,57,49,38,34,32,35,61,51,49,60,47,52,44,49,55,35,41,48,35,51,57,62,62,35,43,44,48,45,32,45,50,44,46,37,32,40,38,55,46,52,55,42,39,45,54,47,57,38,58,54,62,61,58,44,42,37,52,46,45,45,45,44,58,62,54,31,60,62,46,54,55,49,58,50,39,48,52,62,47,33,59,46,35,60,43,53,52,63,38,33,56,34,31,40,61,35,63,39,56,63,38,33,32,60,53,60,51,39,34,58,43,45,44,62,33,50,45,52,56,52,34,47,37,31,50,33,35,34,45,60,62,58,53,59,43,31,38,55,59,47,55,36,54,41,63,60,54,40,47,42,52,35,48,39,39,57,52,58,62,32,43,54,46,57,31,48,51,60,32,41,54,62,32,39,47,59,58,58,51,41,51,60,43,62,53,33,62,36,50,55,54,32,36,51,44,56,37,60,39,33,47,58,55,60,37,35,38,48,40,57,41,43,53,48,56,59,50,43,36,62,49,58,53,48,50,46,52,32,45,39,50,62,52,61,43,51,43,39,51,36,54,60,58,38,62,36,31,34,44,49,55,32,52,49,56,34,53,63,44,47,57,34,43,42,33,39,43,36,37,33,56,58,50,51,35,50,41,51,44,59,38,56,50,55,56,51,53,32,42,41,61,59,48,41,41,32,34,48,48,35,34,47,63,42,38,58,50,51,32,35,33,48,40,39,63,62,43,55,38,49,38,58,44,40,57,43,44,41,48,55,46,32,60,53,36,46,35,58,56,47,47,53,53,53,51,43,31,36,58,44,34,59,46,46,51,42,47,47,59,42,41,43,33,61,61,37,55,34,37,50,63,42,35,40,57,60,61,37,37,32,53,38,36,46,32,41,54,36,54,32,46,50,60,39,51,44,46,46,38,52,50,60,32,36,53,48,41,59,44,40,60,55,34,54,61,45,45,57,59,48,61,45,56,58,52,41,38,55,35,42,50,46,43,36,43,53,63,44,49,61,43,47,50,55,60,45,61,41,56,31,63,44,48,42,39,41,50,41,46,46,50,41,62,48,34,55,48,42,56,55,50,37,42,57,56,38,45,53,60,33,34,56,41,46,42,54,63,48,35,37,37,36,54,59,47,53,58,39,41,58,60,46,45,36,62,32,46,41,35,40,33,38,46,53,45,37,51,40,63,38,43,40,43,40,48,56,37,60,48,33,62,44,60,43,53,36,48,54,60,46,39,39,42,52,45,40,61,39,35,58,43,34,45,53,48,57,40,31,61,31,56,40,49,38,40,40,63,44,60,40,36,56,42,33,49,49,42,51,58,58,37,60,34,60,62,43,38,49,40,57,53,62,40,44,44,55,52,54,41,38,46,47,37,47,52,63,32,44,35,39,37,40,35,44,53,45,34,34,40,40,51,42,38,49,57,47,35,61,33,62,40,51,36,44,62,57,39,50,44,46,52,46,36,31,42,60,49,60,35,41,48,51,59,53,44,42,36,36,46,49,52,33,36,38,52,59,48,62,61,48,48,50,35,49,37,31,61,52,31,34,40,51,38,46,48,56,48,50,62,50,52,46,57,48,43,62,46,52,34,33,31,52,62,58,36,53,36,61,48,42,58,57,48,41,46,38,57,38,53,38,47,41,50,36,52,46,39,54,47,62,54,55,37,53,58,40,43,37,40,51,47,54,44,41,57,40,57,32,46,31,32,31,43,35,47,57,59,32,59,62,40,62,58,55,37,51,52,50,33,31,48,48,51,46,53,51,43,40,44,42,37,60,54,57,56,50,48,58,45,33,47,32,33,53,48,56,31,41,38,39,41,51,40,61,38,61,62,34,53,37,45,37,41,42,33,37,42,35,52,56,38,49,42,47,42,56,37,48,60,60,57,47,36,46,45,54,42,41,57,41,45,31,57,46,35,61,61,33,56,53,34,44,36,35,53,43,36,57,41,34,37,42,53,35,51,57,62,60,35,60,34,46,53,32,63,56,36,43,33,55,36,61,40,39,44,31,58,62,39,48,62,43,51,34,36,54,63,60,54,41,32,47,31,57,57,61,54,46,59,45,49,51,54,59,51,35,48,46,57,31,43,37,50,42,32,42,44,39,52,38,45,44,49,36,63,40,44,43,41,53,49,47,53,53,41,49,38,47,62,33,32,62,51,47,48,58,37,45,52,53,46,45,51,34,53,61,63,53,54,38,55,56,36,46,44,33,47,37,38,38,58,39,35,48,35,56,61,39,40,46,38,36,45,52,58,39,53,54,58,32,61,63,36,55,32,53,56,46,34,40,33,59,54,54,37,58,58,31,53,43,33,38,42,51,53,62,56,39,41,54,57,60,53,61,44,62,48,43,40,37,63,39,58,50,32,43,43,36,43,42,34,55,56,35,41,37,32,32,43,63,41,34,48,39,39,38,52,39,63,32,47,49,54,61,63,43,50,50,38,36,40,40,38,56,33,37,53,41,44,32,46,32,47,46,42,54,56,49,48,38,33,42,56,50,32,31,51,49,53,59,54,60,37,42,46,48,46,60,44,56,40,50,35,51,57,60,53,59,53,51,44,34,31,37,52,36,33,32,33,43,56,57,48,42,34,46,51,35,41,61,45,36,42,31,54,37,37,54,44,38,36,62,34,33,41,46,50,36,43,56,34,43,49,35,39,46,44,62,33,41,47,35,44,31,45,58,45,39,33,38,51,41,62,47,49,50,34,39,43,32,51,35,47,43,61,44,46,50,46,55,56,45,60,51,42,35,54,58,32,48,36,58,41,59,31,40,51,53,52,43,58,60,59,56,31,62,54,36,56,44,38,41,40,40,40,42,61,40,59,57,38,58,59,62,62,35,42,55,37,37,44,47,60,50,49,57,58,51,33,58,38,32,53,39,32,43,52,33,39,31,35,60,51,60,32,39,53,60,47,43,52,59,41,44,46,46,54,53,62,59,56,49,31,57,36,54,54,42,58,46,39,46,56,61,47,43,58,36,51,33,37,47,59,63,56,34,55,40,58,62,55,58,41,62,54,38,37,55,51,45,35,38,36,57,39,38,37,53,60,53,60,41,56,53,32,59,57,56,46,47,54,43,60,54,37,47,47,35,51,40,48,41,52,49,61,59,33,47,38,50,47,31,49,38,32,37,59,57,33,34,40,54,36,51,57,37,40,55,61,60,44,62,42,37,46,40,40,37,49,43,43,44,32,36,40,34,32,51,55,38,45,45,38,42,35,45,32,36,39,38,51,37,38,46,55,38,54,49,57,58,53,52,31,44,41,39,56,45,48,35,60,45,43,37,58,48,39,40,40,50,42,35,47,61,40,50,59,39,54,41,36,53,35,31,60,32,62,46,53,42,51,57,63,54,43,35,60,39,54,58,57,56,63,39,41,60,46,54,43,53,41,47,43,32,61,39,44,45,51,44,60,56,59,53,45,54,58,58,33,44,48,46,42,51,54,38,36,57,62,44,47,33,63,45,36,40,61,51,49,49,39,59,37,54,50,35,40,60,44,62,45,52,54,52,33,52,61,58,62,33,48,60,49,35,58,45,36,47,42,31,61,54,37,63,59,60,43,57,45,32,35,58,33,40,56,62,38,63,43,38,56,47,41,33,60,38,37,45,33,48,47,49,53,44,49,39,52,35,39,46,57,59,60,41,36,54,35,42,32,33,33,43,37,36,54,47,56,44,42,42,37,39,45,58,59,41,51,41,53,43,50,57,39,36,38,44,47,51,59,48,37,32,33,57,39,37,61,44,45,33,48,50,54,33,52,35,60,35,59,40,39,62,38,43,58,50,46,58,54,42,60,33,33,52,50,39,42,31,40,34,35,39,37,33,55,58,51,51,34,48,56,60,33,53,46,49,36,51,49,53,32,50,55,42,58,57,45,38,43,55,35,44,32,54,33,59,37,61,36,32,59,54,41,58,44,50,46,40,35,46,36,40,44,52,35,57,48,57,37,32,39,41,57,40,40,52,34,36,39,36,54,46,49,51,36,58,53,45,35,44,49,46,44,40,43,42,62,44,50,44,43,56,59,58,50,31,47,43,48,46,50,43,38,38,42,54,48,37,51,41,53,32,47,54,32,40,51,50,32,56,34,50,62,37,39,44,32,37,43,58,38,48,60,59,50,42,63,33,44,47,41,44,49,37,51,48,55,32,39,41,55,60,59,57,45,38,45,41,62,32,55,56,38,54,35,57,52,56,62,38,53,34,60,43,62,52,50,53,61,59,37,43,54,58,33,58,35,41,55,61,62,50,54,42,60,37,53,49,52,59,51,53,39,54,33,48,40,45,42,40,41,49,36,37,57,63,43,51,57,37,59,60,32,51,39,59,44,63,52,51,62,37,58,61,59,58,55,39,39,54,42,42,58,46,42,52,55,37,46,47,48,44,32,31,57,52,44,35,56,37,57,43,35,55,58,55,51,54,37,48,33,32,59,50,51,44,53,39,50,51,55,38,48,49,52,54,49,50,47,38,48,43,39,40,31,59,38,46,43,56,56,37,48,38,56,57,63,32,41,38,37,40,42,37,49,56,41,60,42,60,34,41,39,33,41,38,36,34,35,40,58,46,47,56,42,39,61,41,43,53,41,34,61,55,57,38,31,44,34,48,31,63,34,50,57,38,54,32,38,60,54,45,40,33,58,59,60,32,31,56,52,41,63,37,42,51,53,37,49,56,61,62,59,49,48,51,42,43,45,56,38,39,40,32,48,57,43,50,33,55,32,33,37,50,56,46,37,48,43,40,31,50,59,54,37,49,36,41,38,50,44,57,56,56,50,40,52,57,55,40,41,43,47,44,38,36,44,50,42,57,43,54,59,38,38,53,44,53,40,32,60,53,36,61,48,33,47,49,36,43,36,32,50,39,40,57,52,43,51,45,50,56,54,52,40,54,46,53,46,61,32,48,34,49,44,36,54,32,58,37,50,53,36,35,32,52,63,57,56,41,47,53,38,62,44,42,43,55,52,51,54,48,44,31,51,54,42,40,57,52,53,43,47,58,62,39,62,43,40,41,53,42,51,60,42,50,31,33,39,44,37,61,57,44,62,32,58,41,60,57,43,49,48,50,38,59,45,62,38,37,61,40,49,35,57,52,49,36,51,51,50,61,63,35,51,55,43,47,44,43,34,51,42,53,42,36,52,47,59,55,54,44,55,41,57,52,34,50,39,49,62,49,51,52,62,34,58,37,49,52,44,62,56,47,54,57,43,37,33,34,51,40,60,45,31,37,49,59,54,59,39,45,40,60,34,54,56,38,50,48,36,38,47,57,55,46,33,60,37,42,38,41,34,59,61,45,31,56,38,44,58,39,34,56,45,54,40,47,62,49,49,54,49,34,53,54,33,59,34,37,46,57,56,62,36,51,38,59,62,41,46,44,62,61,60,33,40,62,43,35,46,43,35,50,43,55,36,47,39,62,50,49,35,44,47,37,59,34,60,63,58,51,55,45,37,47,56,63,35,41,36,50,53,32,43,49,56,59,54,49,61,37,42,52,37,58,61,49,37,32,35,43,53,35,38,58,55,41,39,31,61,50,52,51,57,36,38,57,52,34,35,32,56,44,56,61,56,61,32,58,41,43,45,37,34,46,42,42,46,58,62,54,33,38,38,52,38,49,48,41,32,40,39,48,43,32,61,33,33,56,61,58,41,49,59,59,63,46,34,44,39,38,53,59,56,62,44,41,58,41,58,52,51,52,32,59,51,40,31,57,43,57,55,42,44,38,55,32,56,55,44,44,42,33,40,60,61,44,41,38,45,44,37,55,36,58,45,57,34,55,58,42,52,34,31,53,38,62,34,56,46,46,39,39,54,58,54,44,47,51,49,34,61,59,40,43,34,36,33,45,53,44,53,34,42,40,37,56,48,36,53,57,47,59,37,35,63,55,37,33,58,52,32,57,51,51,40,31,49,46,41,59,33,53,56,42,38,57,48,52,40,40,55,33,59,39,53,47,55,51,37,49,35,59,41,51,61,43,34,34,36,34,40,59,52,33,34,46,61,33,48,58,33,47,50,37,32,59,47,33,34,35,57,61,53,59,48,62,49,54,62,59,56,56,42,38,32,37,50,45,34,62,36,47,48,31,47,61,50,59,47,57,43,43,63,51,38,33,40,48,33,59,38,56,58,34,43,57,61,38,59,39,39,40,35,44,51,55,58,61,35,35,42,46,32,43,52,61,43,48,41,33,41,45,50,35,57,54,32,60,41,39,45,35,48,42,48,41,57,58,53,60,52,62,36,49,47,47,43,59,47,60,35,56,55,53,36,48,46,51,35,48,39,33,48,38,36,54,54,34,44,61,51,48,36,39,48,51,46,61,37,37,37,41,50,53,37,59,37,35,41,31,60,45,37,34,37,35,41,55,52,38,41,41,32,54,32,63,39,63,44,33,41,41,32,40,49,41,32,48,52,43,46,55,52,57,52,54,58,42,39,32,34,37,62,58,40,54,57,43,51,38,43,54,49,50,39,56,38,62,46,33,62,36,59,37,56,40,53,60,35,40,42,51,57,42,42,38,39,47,54,54,43,50,51,54,32,62,59,62,41,33,45,50,61,36,53,59,43,47,59,33,36,35,35,39,44,34,63,42,51,49,53,45,35,55,54,46,48,53,39,40,50,54,53,44,54,42,56,34,31,33,41,52,52,58,40,39,37,38,51,46,53,61,32,42,36,39,54,57,48,35,53,58,61,59,50,59,52,58,41,43,43,60,40,63,58,45,58,39,50,54,59,56,54,45,36,36,44,49,58,52,36,56,37,60,42,60,50,45,48,46,55,36,37,35,58,52,39,55,57,46,39,63,43,48,45,48,36,38,57,32,62,44,57,59,60,45,44,49,54,46,38,40,34,38,56,41,56,41,53,48,38,45,56,46,43,42,47,54,39,52,46,44,62,51,44,55,33,52,59,40,55,62,48,58,47,46,57,47,32,59,38,55,54,52,36,36,47,50,57,55,33,63,57,55,40,46,55,62,43,37,40,32,49,43,31,52,44,47,58,36,51,45,45,35,49,62,57,60,53,62,42,35,60,52,47,62,52,33,35,35,34,60,56,60,40,55,34,31,44,46,40,36,42,56,51,54,50,47,36,41,63,57,51,59,37,62,38,60,40,33,39,34,61,34,45,37,38,54,58,53,40,59,47,51,35,50,41,39,45,55,42,34,42,31,52,59,57,42,53,58,50,54,54,31,52,38,36,48,39,35,47,62,50,39,32,44,55,59,54,62,36,46,51,61,31,42,43,41,40,35,50,48,38,57,33,42,44,59,53,50,62,60,45,50,61,38,52,38,35,51,47,35,34,42,60,51,50,55,57,42,63,42,46,51,63,46,41,34,41,56,56,35,51,36,37,61,45,52,58,40,45,61,51,32,31,56,39,42,40,57,52,43,44,54,57,58,52,37,62,58,34,41,34,45,58,36,59,49,47,52,56,35,61,54,41,39,56,61,42,57,41,56,42,55,32,62,53,35,40,31,53,57,35,44,49,56,50,54,55,52,45,57,58,62,55,57,52,56,37,39,34,60,34,35,53,34,38,56,32,59,63,46,42,55,56,52,54,51,41,61,50,56,42,31,61,61,58,62,62,55,58,42,55,55,56,54,49,36,32,43,43,46,37,32,48,31,43,38,58,39,52,52,58,54,33,56,62,58,41,61,54,59,40,58,59,44,45,55,63,56,59,42,57,43,46,50,58,42,61,57,52,56,56,53,42,57,45,59,45,47,44,43,34,32,49,57,45,51,45,54,57,31,34,63,47,33,39,52,39,31,36,33,36,48,38,40,51,46,35,41,53,61,56,53,32,38,39,44,34,49,50,46,33,50,38,32,37,50,36,41,38,35,50,51,36,55,60,49,57,39,37,32,59,40,35,48,35,54,62,54,41,40,56,48,46,60,50,50,63,35,57,51,57,52,63,48,57,39,50,36,32,31,49,41,47,60,39,59,46,33,37,52,61,54,53,43,37,43,42,36,38,40,47,31,34,51,50,50,60,32,43,48,60,34,54,53,35,52,57,47,44,34,54,53,57,55,34,51,33,37,62,41,47,60,49,35,32,41,49,42,37,62,44,59,44,48,59,37,56,46,31,46,46,49,45,33,34,44,41,36,54,55,41,56,50,36,39,63,60,46,41,62,40,57,50,47,60,41,45,47,53,50,40,57,49,48,59,37,35,53,45,53,56,57,43,35,37,55,59,43,45,42,54,58,42,50,49,52,43,61,45,39,36,52,57,41,52,58,58,48,32,38,53,45,39,51,34,47,58,57,45,62,46,59,44,48,43,58,51,55,57,63,56,63,55,47,34,62,61,47,52,40,41,34,63,47,41,32,35,55,51,61,58,42,61,56,33,36,33,37,40,55,38,37,38,43,63,38,46,60,48,57,36,42,57,42,40,41,44,50,47,44,39,32,53,34,58,39,47,62,49,59,31,60,41,51,53,37,32,58,52,31,54,56,37,51,34,55,56,54,51,43,47,37,51,40,56,55,48,58,49,61,48,50,43,43,46,42,50,55,55,49,59,34,45,42,44,46,36,32,50,54,45,62,60,31,51,42,39,33,60,61,56,39,48,44,63,42,56,35,50,48,47,56,33,35,59,53,42,45,44,36,50,31,31,56,42,61,34,45,52,43,43,62,42,61,36,33,59,36,48,33,62,50,44,42,45,37,42,41,62,46,37,51,36,45,46,51,60,55,48,42,61,47,35,51,57,34,38,34,57,35,35,56,32,50,49,54,45,32,35,62,38,47,59,63,36,57,41,39,36,55,51,60,62,62,32,32,45,45,45,60,36,49,31,54,54,57,59,53,58,53,58,43,60,46,43,54,46,54,34,55,51,34,56,61,54,49,57,54,40,61,62,61,46,54,55,31,38,38,59,51,50,39,59,58,57,39,31,33,58,34,38,33,58,38,48,42,42,43,43,43,55,46,34,57,35,52,60,41,48,60,42,45,61,32,58,41,54,43,50,36,54,62,44,37,40,35,38,47,38,39,42,46,37,48,59,55,54,36,51,44,58,34,45,49,34,43,42,46,38,57,32,46,40,33,45,57,32,50,43,37,34,35,60,44,42,43,48,45,46,60,38,51,35,45,41,58,55,31,37,40,42,37,47,62,63,59,49,45,46,54,33,44,46,58,33,59,47,57,39,47,62,47,47,58,54,49,36,36,36,52,48,32,48,45,55,41,32,40,63,48,49,42,53,51,44,59,45,60,58,49,62,40,61,44,39,59,48,48,62,56,34,47,34,34,53,36,48,52,41,61,51,42,50,38,40,62,48,59,45,35,47,61,56,46,35,55,62,50,49,59,40,57,39,37,45,54,50,32,42,50,51,61,61,45,31,61,54,59,36,37,37,31,55,38,39,57,35,35,39,62,43,56,40,33,32,44,32,34,41,51,42,39,37,44,45,39,44,56,49,61,39,62,51,38,50,38,33,39,51,56,37,41,32,53,38,38,59,34,46,34,54,53,53,47,37,35,46,54,45,53,59,52,39,41,57,56,62,51,49,40,51,53,52,52,48,33,45,56,49,55,54,51,33,58,49,62,59,48,38,60,59,58,48,31,62,59,39,48,36,43,37,46,58,50,46,55,49,50,41,34,53,41,38,56,32,41,56,46,33,45,43,58,62,45,56,42,40,49,37,59,42,32,53,36,45,36,36,38,49,42,43,58,62,35,47,34,60,59,37,42,51,59,36,46,41,32,46,37,46,34,33,43,59,37,31,35,31,48,47,50,47,47,36,55,52,43,48,39,36,50,61,45,53,38,32,42,39,50,59,34,42,52,52,55,36,50,42,45,47,51,57,49,47,60,60,34,59,55,37,52,46,41,34,47,39,57,50,35,45,38,49,58,43,63,51,35,34,57,53,51,56,60,35,45,36,44,60,38,42,63,47,33,42,59,53,47,44,55,63,55,57,38,58,57,57,57,39,35,43,58,50,55,50,38,56,52,44,47,35,35,50,42,50,41,56,52,50,52,46,55,48,40,44,43,60,32,34,39,62,35,54,49,43,36,61,57,45,35,36,32,52,47,55,40,57,61,32,33,50,40,40,49,33,46,61,58,33,48,39,42,48,50,46,34,32,36,47,51,62,49,36,39,60,48,61,54,34,45,57,49,51,43,58,55,54,62,32,59,42,50,63,35,48,60,45,41,38,43,55,42,52,42,63,54,49,44,56,48,58,54,55,33,37,33,61,37,55,50,38,41,57,35,32,41,35,52,36,51,37,52,54,49,56,48,60,48,35,50,57,44,35,47,41,32,33,45,59,45,43,35,58,33,36,48,61,50,44,58,56,55,61,52,55,43,60,45,55,43,41,55,42,35,62,37,47,48,37,39,53,43,57,34,56,62,52,55,39,60,48,54,33,39,31,58,36,40,57,45,45,59,36,36,33,49,45,48,37,62,36,58,40,59,62,42,42,55,32,62,60,45,51,50,60,53,55,38,60,43,35,41,32,62,43,41,60,53,45,43,46,62,35,40,42,36,59,50,36,40,51,44,49,63,45,51,42,42,45,55,56,60,55,62,45,59,49,52,55,54,49,48,40,50,46,56,58,59,56,57,35,57,45,62,49,58,43,41,59,42,36,53,42,55,33,36,56,32,37,51,38,62,41,41,59,60,42,49,38,33,56,49,31,45,46,39,35,56,47,35,58,34,53,46,48,54,62,39,40,53,40,57,41,50,38,51,58,55,32,50,49,50,54,33,62,50,54,34,43,49,61,42,47,40,37,41,38,47,51,54,55,42,44,37,50,33,31,52,41,53,37,54,44,42,34,31,55,32,40,44,44,53,33,52,56,50,61,54,38,62,59,59,32,50,53,43,60,54,47,49,55,40,60,60,45,32,32,45,35,42,59,35,57,46,32,32,56,57,45,37,61,38,59,39,46,58,52,45,47,49,58,48,32,36,46,44,56,44,61,39,53,47,60,45,38,49,44,32,35,43,46,45,57,43,37,62,47,50,47,52,57,55,60,31,47,32,56,49,35,41,48,46,38,47,47,60,58,36,52,45,39,32,43,54,56,54,39,62,34,61,46,36,46,60,46,47,39,34,54,60,59,55,53,46,31,35,60,56,51,37,44,33,59,48,50,35,33,59,40,37,51,63,60,49,54,37,42,47,63,44,33,59,47,35,45,36,41,61,34,34,41,53,42,47,52,60,38,33,33,59,35,53,62,51,42,60,51,43,41,53,56,58,56,33,57,32,46,51,52,52,32,57,42,48,53,48,51,55,46,61,49,38,54,32,38,52,38,41,33,42,40,48,36,35,63,38,47,57,52,43,32,51,58,56,57,45,33,55,43,53,61,52,57,36,58,57,41,51,53,52,40,38,43,63,33,31,59,52,59,36,54,39,45,35,50,61,49,33,58,51,50,61,52,36,53,62,45,39,48,50,52,36,33,58,56,60,48,51,39,61,53,45,45,36,31,62,44,35,57,50,59,45,41,44,55,42,37,32,59,63,57,42,58,57,58,33,45,42,40,34,43,36,55,45,38,52,53,56,53,45,42,33,43,38,31,59,38,39,53,32,32,51,56,46,49,50,39,51,45,39,33,35,33,38,37,58,43,33,56,56,57,38,39,52,52,47,45,46,40,36,46,57,59,59,41,53,49,58,34,39,54,35,36,34,59,34,42,54,60,47,49,62,56,40,39,60,33,52,44,48,36,46,38,52,50,57,44,37,32,39,44,62,56,33,55,57,41,52,38,48,35,32,54,53,47,49,36,34,60,31,62,58,52,35,49,47,45,60,35,59,39,48,62,46,32,50,47,54,51,31,33,37,58,31,32,48,37,33,58,54,57,43,34,50,59,52,42,33,35,55,61,62,45,43,41,50,51,62,32,62,40,36,49,48,43,57,54,40,39,43,60,34,45,49,44,32,59,47,60,51,54,50,56,62,37,50,58,62,51,34,31,56,38,43,48,53,32,44,63,59,34,38,47,45,56,49,35,35,33,50,51,59,54,45,35,45,43,40,53,59,46,34,43,54,31,33,62,55,37,59,45,54,37,59,58,40,60,32,53,43,52,40,61,60,51,45,42,40,34,61,54,31,56,60,58,36,35,45,50,41,32,61,33,49,31,49,49,47,57,40,57,54,58,53,61,49,42,60,52,42,33,60,51,48,41,42,53,63,56,57,53,62,52,60,42,62,61,44,61,58,56,41,39,56,56,35,45,34,43,45,60,42,56,57,42,57,35,63,34,56,55,35,35,59,58,36,56,43,36,43,43,43,54,53,49,34,31,38,32,36,31,49,43,59,42,56,35,38,58,55,43,45,45,60,52,55,44,57,36,55,39,45,57,61,54,37,58,50,59,46,62,55,47,60,38,39,54,33,53,48,40,46,45,53,51,36,58,53,60,50,53,32,55,57,57,54,52,63,42,49,56,31,37,33,51,55,33,34,61,44,57,38,48,62,53,59,36,39,56,55,32};


uint8_t *osc[3];// = &sine_25;
//uint8_t *osc2;
//uint8_t *osc3;
uint8_t i,j;

uint8_t sample=0;
uint8_t sample2=0;

uint8_t tmp_sample = 0;
uint8_t tmp_sample2 = 0;

//which keys are playing right now?
//raw means that they aren't debounced!
uint8_t raw_keys_playing[] = {1,0,0};
//these are one until their release time (adsR) has gone to zero
uint8_t voices_playing[] = {0,0,0};
//the pitch of the different notes, should stay constant!
uint8_t note_values[] = {0,0,0};
//the sample values of the different keys
int8_t sample_values[] = {0,0,0};
//how many keys are pressed right now?
uint8_t n_keys_playing = 1;
//...
uint8_t total_output=0;
//debounce arrays
uint8_t buttons_pressed_confidence[] = {0,0,0};
uint8_t buttons_released_confidence[] = {0,0,0};
//keys_playing, debounced!
uint8_t keys_pressed[] = {0,0,0};
uint8_t keys_released[] = {0,0,0};

uint8_t adsr_counter[]= {0,0,0};

uint8_t counter=0;
uint8_t volume_correction=1;

//uint8_t inputs[1];

//ADSR Envelope, time it takes etc,
//0 is immediate, 16 is around 4 seconds? (for A,D,R!)
uint8_t A[OSCILLATORS], D[OSCILLATORS], S[OSCILLATORS], R[OSCILLATORS];
uint8_t adsr_envelope[OSCILLATORS];
//boolean that switches to 0 when attack is done
uint8_t attack[] = {1,1,1};

//the different current volumes of the voices
uint8_t volumes[] = {0,0,0};
uint16_t lfsr = 0xACE1u;

volatile uint8_t value =0;
char out[4];

//get the length of an array
uint8_t length(uint8_t array[]){
	return (uint8_t)sizeof(array)/sizeof(array[0]);
}

ISR(ADC_vect)
{
	value = ADCH;
	ADCSRA |= (1 << ADSC);
}

int main(void)
{
	//initiate ADC!
	ADCSRA |= (1 << ADEN) | (1 << ADIE) | (1 << ADSC);
	ADMUX |= (1 << ADLAR);
	
	
	
	
	DDRC = 0xff;
	
	A[0] = 0;
	D[0] = 0;
	S[0] = 80;
	R[0] = 0;
	
	
	A[1] = 0;
	D[1] = 0;
	S[1] = 80;
	R[1] = 0;
	
	A[2] = 0;
	D[2] = 0;
	S[2] = 80;
	R[2] = 0;
	
	
	
	//BRA TUTA: 950 som grund, detune0 = 0, detune1=500, detune2=1500! (sawtooth)
	
	
	//PORTC = 0xff;
	
	//3355 when 1000 Hz
	//setfreq(0, 100);
	
	//uint32_t templong;
	
	//templong = 1000;
	//freq_coefficient[0]=60*65536/FS;
	
	freq_coefficient[0] = 400;
	//freq_coefficient[1] = 300;
	//freq_coefficient[1] = 400;
	//freq_coefficient[2] = 600;
	
	detune[0] = 0;
	detune[1] = 0;
	detune[2] = 0;
	
	volumes[0] = 255;
	volumes[1] = 255;
	volumes[2] = 255;
	
	//freq_coefficient[1] = 2000;
	//set global interrupts
	sei();
	//generate_pulse(128);
	osc[0] = sine;
	osc[1] = sawtooth;
	osc[2] = sine;
	//osc[1] = sine;
	//osc[2] = sawtooth;
	
	DDRB = 0xff;
	DDRD = 0xff;
	DDRC = 0xff;
	//PORTB = 0xff;
	
	//TIMER1
	//tone generation
	////////PWM 16 BIT TIMER1////////
	//SET TO FAST PWM, 8 BIT
	
	// for FAST PWM (8-Bit PWM) on OC1A
	//TCCR1A = (1 << WGM10) | (1 << COM1A1);
	TCCR1A = (1 << WGM10);
	
	// tmr1 running on MCU full speed clock
	TCCR1B = (1 << WGM12) |(1 << CS10);
	//TCCR1B = (1 << WGM12) | (1 << CS10) | (1 << CS11);
	
	TIMSK1 |= (1 << TOIE1);
	/////////////////////////////////
	
	//TIMER0
	//other things! AROUND 100 Hz! (20000000/(195*1024))
	////////PWM 8 BIT TIMER0////////
	TIMSK0 = _BV(OCIE0A);  // Enable Interrupt TimerCounter0 Compare Match A (SIG_OUTPUT_COMPARE0A)
	TCCR0A = _BV(WGM01);  // Mode = CTC
	//TCCR0B = _BV(CS02);		//clock/256
	//TCCR0B = _BV(CS00);   //no prescaler
	//TCCR0B = _BV(CS01);		//clock/8
	//TCCR0B = _BV(CS01) | _BV(CS00); //clock/64
	TCCR0B = _BV(CS00) | _BV(CS02);		//clock/1024
	OCR0A = 195;
	////////////////////////////////
	
	
	//TIMER2
	//FOR DEBOUNCING ETC! 1250 Hz! (20000000/(64*250))
	//FOR DEBOUNCING ETC! 25000 Hz! (20000000/(8*100))
	////////PWM 8 BIT TIMER2////////
	TIMSK2 = _BV(OCIE2A); //enable interrupt compare match A
	TCCR2A = _BV(WGM21);  //CTC Mode, TOP at OCR2A
	OCR2A = 100;
	//TCCR2B = _BV(CS22); //clock/64
	
	TCCR2B = _BV(CS21); //clock/8
	//TCCR2B = _BV(CS20); //clock
	////////////////////////////////
	
	//l74hc165_init();
	
	sei();
	
	uint8_t inputs[1];
	
	lcd_init(LCD_DISP_ON);
	//lcd_clrscr();
	lcd_puts("hejsan!");
	//lcd_clrscr();
	
	//DDRA = 0xff;
    while(1)
    {
		
		//play_note(500,0);
		//What to do here?
		//maybe read some inputs!
		//l74hc165_shiftin(inputs);
		
		//PORTC = inputs[0];
		
		//play_note(500,0);
		//keys_pressed[1] = 0;
		//keys_pressed[0] = 0;
		
		//_delay_ms(5000);
		//_delay_ms(5000);
		
		/*
		if(value > 128)
		lcd_puts("hej ");
		else
		lcd_puts("bajs");
		*/
		sprintf(out, "%3i", value);
		lcd_puts(out);
		_delay_ms(4000);
		lcd_clrscr();
    }
}

//tone generation
ISR(TIMER1_OVF_vect)
//ISR(TIMER1_COMPA_vect)
{
	//PORTB = 0xff;
	static uint16_t phase0, phase1, phase2, phase3, phase4, phase5;
	static uint8_t fas;
	static int16_t temp, temp1;
	static uint8_t k=0,flag=0;
	static uint8_t timer;
	static uint16_t noise=0xAA,noise8;
	static uint16_t sig0, sig1, sig2, sig3, sig4, sig5;
	static uint16_t tempphase, tempphase1;
	
	flag ^= 1;
	//if(flag)
	//{
		
		
		//VOICE 1 (3 OSC)
		///////////////////////////////////////
		tempphase = phase0+freq_coefficient[0]; //0.88us
		//sig0 = osc[0][phase0>>8]*voices_playing[0];
		//sig0 = osc[0][phase0>>8];
		//sig0 = osc[0][phase0>>8];
		k = osc[0][phase0>>8];
		//sig0 = osc[0][fas];
		//sig0 = noise8;
		//sig0 = (lfsr>>8)*volumes[0]*voices_playing[0];
		phase0=tempphase;
		fas++;
		/*
		tempphase = phase1+freq_coefficient[0]+10; //0.88us
		//sig1 = osc[1][phase1>>8]*voices_playing[0];
		sig1 = osc[1][phase1>>8];
		//sig0 = noise8;
		//sig0 = (lfsr>>8)*volumes[0]*voices_playing[0];
		phase1=tempphase;
		
		tempphase = phase2+freq_coefficient[0]+20; //0.88us
		//sig2 = osc[2][phase2>>8]*voices_playing[0];
		sig2 = osc[2][phase2>>8];
		//sig0 = noise8;
		//sig2 = (lfsr>>8)*voices_playing[0]*80;
		phase2=tempphase;
		///////////////////////////////////////
		
		
		
		//VOICE 2 (3 OSC)
		///////////////////////////////////////
		tempphase = phase3+freq_coefficient[1]; //0.88us
		//sig0 = osc[0][phase0>>8]*voices_playing[0];
		sig3 = osc[0][phase0>>8];
		//sig0 = noise8;
		//sig0 = (lfsr>>8)*volumes[0]*voices_playing[0];
		phase3=tempphase;
		
		tempphase = phase4+freq_coefficient[1]+10; //0.88us
		//sig1 = osc[1][phase1>>8]*voices_playing[0];
		sig4 = osc[1][phase1>>8];
		//sig0 = noise8;
		//sig0 = (lfsr>>8)*volumes[0]*voices_playing[0];
		phase4=tempphase;
		
		tempphase = phase5+freq_coefficient[1]+20; //0.88us
		//sig2 = osc[2][phase2>>8]*voices_playing[0];
		sig5 = osc[2][phase2>>8];
		//sig0 = noise8;
		//sig2 = (lfsr>>8)*voices_playing[0]*80;
		phase5=tempphase;
		///////////////////////////////////////
		
		
		
		
		//LFSR
		// taps: 16 14 13 11; feedback polynomial: x^16 + x^14 + x^13 + x^11 + 1
		noise8  = ((lfsr >> 0) ^ (lfsr >> 2) ^ (lfsr >> 3) ^ (lfsr >> 5) ) & 1;
		lfsr =  (lfsr >> 1) | (noise8 << 15);
		
		
	//}
	//else
	//{
		//temp = sig0>>8+sig1>>8;
		//temp = sig0>>8;
		//temp += sig1>>8;
		temp=0;
		temp = sig0;
		//temp += sig1;
		//temp += sig2;
		
		temp += sig3;
		temp += sig4;
		temp += sig5;
		*/
		//k = temp>>3;
		//temp = sig0;
		//k = temp;
		//OCR1A = k;
		PORTC = k;
		//PORTC = 0b00000000;
	//}
	
	//generate noise!
	/*
	for(k=1;k<2;k++)
	{
		temp1 = noise;
		noise=noise << 1;
		
		temp1 ^= noise;
		if ( ( temp1 & 0x4000 ) == 0x4000 )
		{
			noise |= 1;
		}
	}
	noise8=noise>>6;
	*/
	
		
	
	/*
	sample_values[0] = square_[sample];
	total_output = sample_values[0];
	sample++;
	
	if(sample > 254)
		sample=0;
	
	OCR1A = total_output;
	*/
	
	//for(i=0;i < length(sample_values);i++)
	//	total_output+=sample_values[i]+128;
	
	//OUTPUT EVERYTHING TO THE PWM
	//OCR1A = total_output/n_keys_playing;
	//total_output=0;
	
	////MOVE THIS, IT SLOWS SHIT DOWN!
	//////////////////////////////////
	//Update the sample values in real time:
	/*
	for(i=0;i < length(sample_values);i++)
	{
		tmp_sample = &osc[0][sample];
		
			sample_values[i] = (volumes[i]*tmp_sample/64)*voices_playing[i];

	}
	*/
	
	
	//tmp_sample = &osc[0][sample];	
	//sample_values[0] = (volumes[0]*tmp_sample/64)*voices_playing[0];
	//sample_values[0] = tmp_sample;
	
	//counter++;
	//if(counter % 2 == 0)
		//sample2++;
		
	//if(counter > 200)
	//	counter=0;
	
	//sample++;
	
	//if(sample > 255)
	//	sample = 0;
		
	//if(sample2 > 63)
	//	sample = 0;
	//////////////////////////////////
}

//Runs at approximately 100 Hz
//16000000/(195*1024)
//Good for sequencer?
ISR(TIMER0_COMPA_vect)
{
	
	//PORTB = 0xff;
	//volume_correction = icr >> 6;
	
	//MOVE THIS, IT SLOWS SHIT DOWN!
	////////////////////////////////
	//Update the sample values in real time:
	//for(i=0;i < length(sample_values);i++)
	//{
		//
		//sample_values[i] = (pgm_read_byte(&(osc[0][sample])))*keys_playing[i];
		////sample_values[i] = (pgm_read_byte(&(osc[0][sample])))*keys_playing[i];
	//}
	//
	//counter++;
	////if(counter % 2 == 0)
	//sample++;
	//
	//if(sample > 63)
	//sample = 0;
	////////////////////////////////
}


void play_note(uint16_t note, uint8_t index)
{
	voices_playing[index] = 1;
	//voices_playing[1] = 1;
	//icr = note;
	//OCR1A = note;
}


//timer for debouncer, ADSR etc, runs at exactly 1250 Hz
//20000000/(250*64) OCR2A = 250, prescaler set to fc/64!
ISR(TIMER2_COMPA_vect)
{
	
	
	//PORTC = 0xff;
	
	//ADSR!
	
	for(uint8_t i=0;i < length(voices_playing);i++)
	{
		adsr_counter[i]++;
		if(voices_playing[i] && keys_pressed[i])
		{

			//hasn't reached top, continue to add to attack
			if(adsr_counter[i] > A[i] && volumes[i] <= MAX_LEVEL && attack[i])
			{
				volumes[i]++;
				adsr_counter[i]=0;
				
				if(volumes[i] == MAX_LEVEL) //stop attacking when it's at the top!
					attack[i] = 0;
			}
			
			//start decaying if attack is finished
			else if(adsr_counter[i] > D[i] && volumes[i] > S[i])
			{
				volumes[i]--;
				adsr_counter[i]=0;
			}
		}
		
		//The key is released! reset things and run release
		if(!keys_pressed[i] && adsr_counter[i] > R[i]){
			if(volumes[i] > 0)
				volumes[i]--;
			else
				voices_playing[i] = 0;
			adsr_counter[i]=0;
			attack[i]=1;
			//volumes[i] = 0;
		}
		
	}
	
	
	
	
	
	
	
	
	
	
	/*
	//ADSR!
	for(i=0;i < length(voices_playing);i++)
	{
		adsr_counter[i]++;
		if(voices_playing[i] && keys_pressed[i])
		{

			//hasn't reached top, continue to add to attack
			if(adsr_counter[i] > A && volumes[i] <= 255 && attack[i])
			{
				volumes[i]++;
				adsr_counter[i]=0;
				
				if(volumes[i] == 0xff) //stop attacking when it's at the top!
					attack[i] = 0;
			}
			
			//start decaying if attack is finished
			else if(adsr_counter[i] > D && volumes[i] > S)
			{
				volumes[i]--;
				adsr_counter[i]=0;
			}
		}
		*/
		/*
		else if(!keys_pressed[i])
		{
			//voices_playing[i] = 0;
			if(volumes[0] > 0)
				volumes[0]--;
			if(volumes[0] == 0)
				voices_playing[i] = 0;
			
		}
		*/
		/*
		//The key is released! reset things and run release
		if(!keys_pressed[i] && adsr_counter[i] > R){
			if(volumes[i] > 0)
				volumes[i]--;
			else
				voices_playing[i] = 0;
			adsr_counter[i]=0;
			attack[i]=1;
			//volumes[i] = 0;
		}
		
	}
	*/
	
	
	
	//button debouncing!
	
	if (PINB & (1 << PB0))
	{
		
		buttons_pressed_confidence[0]++;
		if(buttons_pressed_confidence[0] > 20)
		{
			if(keys_pressed[0] == 0)
			{
				if(PINB & (1 << PB0))
				{
					//play_osc1_note(C5, 1, 5);
					play_note(500,0);
					keys_pressed[0] = 1;
				}
				
				//PORTB ^= 1 << PINB5;
				//PORTB = 1 << PINB5;
			}
			
			buttons_pressed_confidence[0]=0;
		}
	}
	else
	{
		buttons_released_confidence[0]++;
		if(buttons_released_confidence[0] > 20)
		{
			keys_pressed[0] = 0;
			//PORTB = 0 << PINB5;
			buttons_released_confidence[0] = 0;
		}
		
	}
	
	
	
	
	
	
	if (PINB & (1 << PB0))
	{
		
		buttons_pressed_confidence[1]++;
		if(buttons_pressed_confidence[1] > 20)
		{
			if(keys_pressed[1] == 0)
			{
				if(PINB & (1 << PB0))
				{
					//play_osc1_note(C5, 1, 5);
					play_note(300,0);
					keys_pressed[0] = 1;
				}
				
				//PORTB ^= 1 << PINB5;
				//PORTB = 1 << PINB5;
			}
			
			buttons_pressed_confidence[1]=0;
		}
	}
	else
	{
		buttons_released_confidence[1]++;
		if(buttons_released_confidence[1] > 20)
		{
			keys_pressed[1] = 0;
			//PORTB = 0 << PINB5;
			buttons_released_confidence[1] = 0;
		}
		
	}
	
	
	
}


void generate_pulse(uint8_t PW)
{
	uint8_t n;
	int16_t val;
	int8_t *wave_array;
	
	//wave_array = square_;
	
	val=-128;
	
	for(n=0;n<=0xff;n++)
	{
		*wave_array=0xFF;
			if(n>PW) // SID has 12Bit pwm, here we use only 8Bit
			{
				*wave_array&=127;
			}
			else *wave_array&=-127;
			
		val++;
		wave_array++;
	}
}

void setfreq(uint8_t voice, uint16_t freq)
{
	uint32_t templong;
	
	templong=freq;
	freq_coefficient[voice]=templong*65536/FS;
}